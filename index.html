<!DOCTYPE html>
<html>
    <head>
        <title>webDICOM</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

        <!--CSS-->
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/jquery-ui-1.10.2.custom.css">

        <!-- jQuery -->
        <script type="text/javascript" src="js/libs/jquery-1.9.1/jquery.min.js"></script>
        <script type="text/javascript" src="js/libs/jquery-ui-1.10.2/jquery-ui.custom.min.js"></script>
        <script type="text/javascript" src="js/libs/jquery.tree.js"></script>
        <!--<script type="text/javascript" src="js/libs/jsTree-2.0.0/jstree.min.js"></script>-->

        <!-- External jsdicom-lib -->
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/dcmdict.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/binutils.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/dcmfile.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/dicomparser.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/transfersyntax.js"></script>
        <script type="text/javascript" src="js/libs/jsdicom-lib/src/qr.js"></script>

        <!--Dicom Viewer-->
        <script type="text/javascript" src="js/DcmViewer.js"></script>
        <script type="text/javascript" src="js/DcmParser.js"></script>
        <script type="text/javascript" src="js/CanvasPainter.js"></script>
        <script type="text/javascript" src="js/Toolbox.js"></script>
        <script type="text/javascript" src="js/Tree.js"></script>

        <!-- Tools -->
        <script type="text/javascript" src="js/tools/WindowLevel.js"></script>
        <script type="text/javascript" src="js/tools/Zoom.js"></script>
        <script type="text/javascript" src="js/tools/Move.js"></script>

        <script>
            $(document).ready(function() {
                var dcmViewer = new DcmViewer('myCanvas');
                var tree = new Tree('#fileTree');
                
                $('#dicomUpload').change(tree.change);
                $('#fileTree').click(function(e) {
                    if(e.target.nodeName === 'A' && e.target.dataset.type === 'file') {
                        var serie = [];
                        var arr = e.target.dataset.index.split(',');
                        for(var i = 0; i < arr.length; i++) {
                            serie.push(tree.parsedFileList[arr[i]]);
                        }
                        dcmViewer.setParsedFiles(serie);
                    }
                });
                $('#buttonSet').change(function() {
                    dcmViewer.setCurrentTool($("input[name='toolbox-buttons']:checked").val());
                });
                $('#resetButton').click(function() {
                    if(dcmViewer.eventsEnabled) {
                        dcmViewer.painter.reset();
                    }
                });
                $('#myCanvas').click(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mousemove(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mousedown(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mouseup(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').mouseout(function(e) {
                    dcmViewer.eventHandler(e);
                });
                $('#myCanvas').bind('mousewheel', function(e) {
                    if(dcmViewer.numFiles > 1) {
                        e.preventDefault();
                        var num = dcmViewer.scrollHandler(e);
                        $('#slider').slider('value', num);
                    }
                });
                // scroll event for firefox
                $('#myCanvas').bind('DOMMouseScroll', function(e) {
                    if(dcmViewer.numFiles > 1) {
                        e.preventDefault();
                        var num = dcmViewer.scrollHandler(e);
                        $('#slider').slider('value', num);
                    }
                });
                $('#buttonSet').buttonset();
                $('#resetButton').button();
            });
        </script>
    </head>
    <body>
        <div id="container">
            <aside id="sidebar">
                <!--<input id="dicomUpload" type="file" accept="application/dicom" multiple />--> 
                <!--Only Chrome supports webkitdirectory-->
                <input id="dicomUpload" type="file" multiple webkitdirectory directory />

                <progress value="0.5"></progress> 

                <div id="fileTree"></div>
            </aside>
            <div id="viewer">
                <div id="toolbox">
                    <span id="buttonSet">
                        <input type="radio" id="windowLevel" name="toolbox-buttons" value="Window level" checked="checked" /><label for="windowLevel">Window level</label>
                        <input type="radio" id="move" name="toolbox-buttons" value="Move" /><label for="move">Move</label>
                        <input type="radio" id="zoom" name="toolbox-buttons" value="Zoom" /><label for="zoom">Zoom</label>
                    </span>
                    <button type="button" class="ui-button-text" id="resetButton" value="Reset">Reset</button>
                </div>

                <canvas id="myCanvas" width="512" height="512">Your browser doesn't support HTML5</canvas>
                <div id="slider"></div>
            </div>
        </div>
    </body>
</html>
